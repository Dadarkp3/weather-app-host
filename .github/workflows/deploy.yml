name: Deploy to Zephyr

on:
  push:
    branches:
      - main

env:
  NODE_VERSION: 22 # Define a versão do Node.js a ser usada

jobs:
  deploy-on-main:
    runs-on: ubuntu-latest # Define o ambiente de execução
    steps:
      - name: Checkout code
        uses: actions/checkout@v3 # Faz o checkout do seu código do repositório

      # Configura o Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }} # Usa a versão definida na variável de ambiente

      # Instala as dependências usando pnpm
      - uses: pnpm/action-setup@v4
        with:
          version: 10.6.3 # Versão do pnpm a ser usada
          run_install: false # Não executa 'pnpm install' automaticamente aqui
      - name: Install dependencies
        run: pnpm i # Executa a instalação das dependências

      # Executa o script de build da sua aplicação (assumindo 'pnpm run build')
      - name: Run CI build
        id: build
        env:
          # ZE_SECRET_TOKEN é passado para o ambiente do script de build, se ele precisar
          ZE_SECRET_TOKEN: ${{ secrets.ZEPHYR_AUTH_TOKEN }}
        run: pnpm run build

      # Faz o deploy para o Zephyr
      - name: Zephyr deploy
        env:
          ZEPHYR_TOKEN: ${{ secrets.ZEPHYR_AUTH_TOKEN }} # Token de autenticação para o Zephyr
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Token padrão do GitHub (caso o Zephyr use para GitHub integrations)
        run: |
          npx @zephyrcloud/cli deploy \
          --application_uid weather-app-host.weather-app-host.dadarkp3 \
          --path dist \
          --github_environment Production
